name: FreeBSD Rust version

on:
  # To run manually workflow
  workflow_dispatch:

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  rust-version:
    name: Get Rust version
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - uses: actions/checkout@v4

    - name: FreeBSD VM
      id: rust-version
      uses: vmactions/freebsd-vm@v1.0.7
      with:
        usesh: true
        sync: rsync
        copyback: true
        prepare: pkg install -y curl bash
        run: |
          set -e

          echo "## OS infos"
          uname -a

          echo "## Install Rust toolchain"
          export CARGO_TERM_COLOR=always
          curl https://sh.rustup.rs -sSf --output rustup.sh
          sh rustup.sh -y --profile=minimal -t stable
          . "${HOME}"/.cargo/env
          rm rustup.sh

          echo "## Rust infos"
          rustc -vV
          echo "## cargo infos"
          cargo -vV

          # Compare Rust versions
          echo "## Compare Rust versions"
          REF_VERSION=$(grep -E "^rustc" freebsd_rust_version.txt | cut -d" " -f2)
          RUST_VERSION=$(rustc -vV | grep -E "^rustc" | cut -d" " -f2)

          echo "REF_VERSION = ${REF_VERSION}"
          echo "RUST_VERSION = ${RUST_VERSION}"

          if [ "$REF_VERSION" == "$RUST_VERSION" ]; then
            echo "Same version"
            echo "same_version=true" >> "$GITHUB_ENV"
          else
            echo "Different versions"
            echo "same_version=false" >> "$GITHUB_ENV"
          fi

    - name: Compare versions
      if: env.same_version == 'true'
      run: |
        printf 'same_version = %s\n' "$same_version"
